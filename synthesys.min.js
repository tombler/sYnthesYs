var app=angular.module("sYnthesYs",["ngRoute","ui.bootstrap"]);app.factory("storage",function(){var a={},b=new AudioContext,c=b.createGain();return{context:b,gain:c,getJunk:function(b){return a.hasOwnProperty(b)?a[b]:void 0},addJunk:function(b,c){a[b]=c}}}).directive("instructionsPopover",function(){return{restrict:"A",link:function(a,b,c){$(b).popover({trigger:"hover",html:!0,content:c.popoverHtml,placement:c.popoverPlacement})}}}).config(["$routeProvider",function(a){a.when("/home",{templateUrl:"./app/templates/home.html",controller:"HomeCtrl"}).when("/keyboard",{templateUrl:"./app/templates/keyboard.html",controller:"KeyboardCtrl"}).when("/custom",{templateUrl:"./app/templates/customSound.html",controller:"CustomSoundCtrl"}).when("/dj",{templateUrl:"./app/templates/dj.html",controller:"DjCtrl"}).otherwise({redirectTo:"/home"})}]),app.controller("CustomSoundCtrl",["$scope","storage","$document","$http","$interval","$window","audioSampleLoader",function(a,b,c,d,e,f,g){function h(b,c,d){if(a.status===!0)for(c;200>c;c+=2)$(d).css("background-color","#00AAAA"),a.changePadColor=e(function(){a.breakLoop||$(d).css("background-color","#00AAAA")},2e3),a.returnPadColor=e(function(){a.breakLoop||$(d).css("background-color","#d3d3d3")},2010),a.source=l.createBufferSource(),a.source.buffer=b,a.source.connect(l.destination),a.source.start(c);else $(d).css("background-color","#00AAAA"),a.source=l.createBufferSource(),a.source.buffer=b,a.source.connect(l.destination),a.source.start(c)}var i=$(".js-loading-bar"),j=i.find(".progress-bar");i.modal("show"),j.addClass("animate"),setTimeout(function(){j.removeClass("animate"),i.modal("hide")},1500);var k,l=b.context;a.bufferPads=[],a.isDisabled=!1,a.breakLoop=!1,a.status=!0;var m=new g;m.src=["sounds/120bpm.mp3","sounds/909BD.wav","sounds/909clap.wav","sounds/HT10.WAV","sounds/crash cymbal.wav","sounds/flam_Fltom.wav","sounds/crash choke.wav","sounds/electronicHH.wav","sounds/hi-hat-open.wav"],m.ctx=l,m.onload=function(){for(var b=0;b<m.response.length;b++)a.bufferPads.push(m.response[b])},m.onerror=function(){alert("Awwwwww snap!")},m.send(),a.playMetronome=function(b){a.isDisabled=!0,a.metSource=l.createBufferSource(),a.metSource.buffer=a.bufferPads[0],a.metSource.connect(l.destination),a.metSource.start()},a.pauseMetronome=function(b){a.isDisabled=!1,a.metSource.disconnect(l.destination),a.metSource.stop()},c.keydown(function(b){68==b.which&&(k="#pad1",h(a.bufferPads[1],l.currentTime,k)),(70==b.which||83==b.which)&&(k="#pad2",h(a.bufferPads[2],l.currentTime,k)),74==b.which&&(k="#pad3",h(a.bufferPads[3],l.currentTime,k)),75==b.which&&(k="#pad4",h(a.bufferPads[4],l.currentTime,k)),88==b.which&&(k="#pad5",h(a.bufferPads[5],l.currentTime,k)),67==b.which&&(k="#pad6",h(a.bufferPads[6],l.currentTime,k)),78==b.which&&(k="#pad7",h(a.bufferPads[7],l.currentTime,k)),77==b.which&&(k="#pad8",h(a.bufferPads[8],l.currentTime,k))}),c.keyup(function(a){$("#sp div").css("background-color","#d3d3d3")}),a.changeStatus=function(){a.status=!a.status},a.reset=function(){f.location.reload()}}]),app.controller("DjCtrl",["$scope","instruments","storage","$http","WaterModel","audioSampleLoader","$interval","$timeout",function(a,b,c,d,e,f,g,h){a.hideModal=!1,a.hide=function(){a.hideModal=!0};var i=c.context,j={FREQ_MUL:7e3,QUAL_MUL:30,playing:!1},k=i.createAnalyser(),l=700,m=500,n=new e(l,m,{resolution:2,interpolate:!1,damping:.92,clipping:5,evolveThreshold:.05,maxFps:30,showStats:!0}),o=new e(l,m,{resolution:2,interpolate:!1,damping:.92,clipping:5,evolveThreshold:.05,maxFps:30,showStats:!0}),p=(new WaterCanvas(l,m,"filter",n,{backgroundImageUrl:"img/kraftwerk.jpg",lightRefraction:39.2,lightReflection:.92,maxFps:20,showStats:!0}),new WaterCanvas(l,m,"delay",o,{backgroundImageUrl:"img/daft-punk.jpg",lightRefraction:9,lightReflection:.92,maxFps:20,showStats:!0}),[[.5,1,.5],[1,1,1],[.5,1,.5]]);a.filter=i.createBiquadFilter(),a.filter.type="string"==typeof a.filter.type?"bandpass":0,a.filter.frequency.value=1e3,a.delayEffect=i.createDelay(2),d({method:"GET",url:"app/data/songs.json"}).success(function(b){a.songData=b,a.currentSongTitle=a.songData[0].title,a.currentSongArtist=a.songData[0].artist,a.currentSongImg=a.songData[0].img}),a.bufferCounter=0,a.songBuffers=[];var q=new f;q.src=["sounds/Clean-Bandit.mp3","sounds/fat-bottomed-girls.mp3","sounds/needYourHeart.mp3","sounds/Sabali.mp3"],q.ctx=i,q.onload=function(){console.log(q.response);for(var b=0;b<q.response.length;b++)a.songBuffers.push(q.response[b])},q.onerror=function(){alert("Awwwwww snap!")},q.send(),a.songsLoading=h(function(){$(".navbar-fixed-bottom").removeClass("loader")},5e3),a.nextSong=function(){a.bufferCounter+=1,console.log(a.source.buffer),0!=a.masterGain.gain.value&&a.pauseSong(),a.playSong(a.songBuffers[a.bufferCounter]),a.currentSongTitle=a.songData[a.bufferCounter].title,a.currentSongArtist=a.songData[a.bufferCounter].artist,a.currentSongImg=a.songData[a.bufferCounter].img},a.prevSong=function(){a.bufferCounter-=1,0!=a.masterGain.gain.value&&a.pauseSong(),a.playSong(a.songBuffers[a.bufferCounter]),a.currentSongTitle=a.songData[a.bufferCounter].title,a.currentSongArtist=a.songData[a.bufferCounter].artist,a.currentSongImg=a.songData[a.bufferCounter].img},a.showPlayButton=!0,a.playSong=function(b){a.showPlayButton=!1,a.source=i.createBufferSource(),a.source.buffer=a.songBuffers[a.bufferCounter],a.masterGain=i.createGain(),a.masterGain.gain.value=.1,a.source.connect(k),k.connect(a.masterGain),a.masterGain.connect(i.destination),a.source.start(0),a.effectSource=i.createBufferSource(),a.effectSource.buffer=a.songBuffers[a.bufferCounter],a.effectGainNode=i.createGain(),a.effectGainNode.gain.value=0,a.effectSource.connect(k),k.connect(a.effectGainNode),a.effectGainNode.connect(i.destination),a.effectSource.start(0)},a.pauseSong=function(){a.showPlayButton=!0,a.masterGain.gain.value=0,a.source.disconnect(k),k.disconnect(a.masterGain),a.masterGain.disconnect(i.destination),a.source.stop(),a.effectSource.stop(),a.selectedRangePercent=100/3+"%",a.selectedRange="100"},a.connectEffectGain=function(){a.effectGainNode.disconnect(i.destination),a.effectGainNode.connect(a.filter),a.filter.connect(i.destination),a.effectGainNode.gain.value=.3,a.masterGain.gain.value=0},a.addEffects=function(b){if(1==b.which){n.touchWater(b.offsetX,b.offsetY,1.5,p);var c=1-.0029*b.offsetY,d=40,e=i.sampleRate/2,f=Math.log(e/d)/Math.LN2,g=Math.pow(2,f*(c-1));a.filter.frequency.value=e*g,a.frequencyDisplay=a.filter.frequency.value;var h=1-.00174*b.offsetX;a.filter.Q.value=h*j.QUAL_MUL}},a.removeEffects=function(){a.filter.disconnect(i.destination),a.effectGainNode.disconnect(a.filter),a.effectGainNode.connect(i.destination),a.effectGainNode.gain.value=0,a.masterGain.gain.value=.1},a.addDelay=function(b){1==b.which&&(o.touchWater(b.offsetX,b.offsetY,1.5,p),a.effectGainNode.disconnect(i.destination),a.delayEffect.delayTime.value=.00575*b.offsetY,a.effectGainNode.gain.value=.05,a.masterGain.gain.value=.05,a.effectSource.connect(k),k.connect(a.delayEffect),a.delayEffect.connect(a.effectGainNode),a.effectGainNode.connect(i.destination))},a.removeDelay=function(b){setTimeout(function(){a.effectGainNode.gain.value=0,a.masterGain.gain.value=.1},1500)},a.changePlaybackRate=function(b){a.selectedRangePercent=(parseInt(b)-50)/1.5+"%";var c=b/100;a.source.playbackRate.value=c,a.effectSource.playbackRate.value=c},a.closeAudio=function(){a.masterGain.disconnect(i.destination)}}]),app.controller("HomeCtrl",["$scope","$location",function(a,b){!function(){function a(a,b){return Math.floor(Math.random()*(b-a+1))+a}function b(){for(e=0;e<d.length;++e)d[e].time||(d[e].time=a(30,100),d[e].deg=a(-179,180),d[e].vel=a(1,5),d[e].curve=a(0,1),d[e].fade=a(0,1),d[e].grow=a(-2,2)),f=d[e].attr("cx"),g=d[e].attr("cy"),i=d[e].vel*Math.cos(d[e].deg*Math.PI/180),j=d[e].vel*Math.sin(d[e].deg*Math.PI/180),f+=i,g+=j,0>f?f=1200+f:f%=1200,0>g?g=1200+g:g%=1200,d[e].attr({cx:f,cy:g}),k=d[e].attr("r"),d[e].grow>0?d[e].attr("r",Math.min(30,k+.1)):d[e].attr("r",Math.max(10,k-.1)),d[e].curve>0?d[e].deg=d[e].deg+2:d[e].deg=d[e].deg-2,l=d[e].attr("fill-opacity"),d[e].fade>0?(d[e].attr("fill-opacity",Math.max(.3,l-.01)),d[e].attr("stroke-opacity",Math.max(.3,l-.01))):(d[e].attr("fill-opacity",Math.min(1,l+.01)),d[e].attr("stroke-opacity",Math.min(1,l+.01))),d[e].time=d[e].time-1,d[e].vel<1?d[e].time=0:d[e].vel=d[e].vel-.05;h=setTimeout(b,60)}var c,d,e,f,g,h,i,j,k,l;for(c=Raphael("canvas",1275,800),d=c.set(),e=0;30>e;++e)l=a(3,10)/10,d.push(c.circle(a(0,800),a(0,800),a(10,30)).attr({"fill-opacity":l,"stroke-opacity":l}));d.attr({fill:"#00DDAA",stroke:"#00DDAA"}),b()}(),a.goToKeyboard=function(){b.url("/keyboard")}}]),app.controller("KeyboardCtrl",["$scope","instruments","storage",function(a,b,c){function d(b){var c=new Float32Array(b),d=new Float32Array(c.length);a.customWave=e.createPeriodicWave(c,d)}var e=c.context,f={id:"keyboard",width:800,height:200,startNote:"A2",whiteNotesColour:"#ff0",blackNotesColour:"#000",borderColour:"#000",activeColour:"#00AAAA",octaves:2},g=new QwertyHancock(f),h=c.gain;a.waveTypeList=["Sine","Sawtooth","Triangle"],a.placeholderWaveValues=[{value:"Enter a number 0-99"},{value:"Enter a number 0-99"},{value:"Enter a number 0-99"},{value:"Enter a number 0-99"},{value:"Enter a number 0-99"}],a.customWaveValues=[],a.radioModel="Waves",a.instruments=b,a.showTable=!0,h.gain.value=.5,h.connect(e.destination),nodes=[],$(document).unbind("keydown"),$(document).unbind("keyup"),a.closeAudio=function(){h.disconnect(e.destination),a.vco=null},a.chooseInstrument=function(b){var c=$(".js-loading-bar"),e=c.find(".progress-bar");c.modal("show"),e.addClass("animate"),setTimeout(function(){e.removeClass("animate"),c.modal("hide")},1500),d(a.instruments[b])},a.toggleTable=function(){a.showTable===!1?a.showTable=!0:a.showTable=!1},a.createWave=function(a){var b=[],c=a.map(Number);c.map(function(a){a/=100,b.push(a)}),console.log(b),d(b)},g.keyDown=function(b,c){a.vco=e.createOscillator(),"Waves"===a.radioModel?a.vco.type=a.waveType.toLowerCase():("Custom"===a.radioModel||"Instrument"===a.radioModel)&&a.vco.setPeriodicWave(a.customWave),a.vco.frequency.value=c,a.vco.connect(h),a.vco.start(0),nodes.push(a.vco)},g.keyUp=function(a,b){for(var c=[],d=0;d<nodes.length;d++)Math.round(nodes[d].frequency.value)===Math.round(b)?(nodes[d].stop(0),nodes[d].disconnect()):c.push(nodes[d]);nodes=c},a.load=function(){var a=$(".js-loading-bar"),b=a.find(".progress-bar");a.modal("show"),b.addClass("animate"),setTimeout(function(){b.removeClass("animate"),a.modal("hide")},1500)}}]),app.factory("audioSampleLoader",function(){function a(){"use strict";this.loaded=0}return a.prototype.send=function(){"use strict";var a,b=window.console;if(this.hasOwnProperty("ctx")){if(!(this.ctx instanceof window.AudioContext))return void b.error("AudioSampleLoader: ctx not an instance of AudioContext")}else this.ctx=new window.AudioContext;if(!this.hasOwnProperty("onload"))return void b.error("AudioSampleLoader: Callback onload does not exist");if("function"!=typeof this.onload)return void b.error("AudioSampleLoader: Callback onload not a function");if(this.hasOwnProperty("onerror")&&"function"==typeof this.onerror||(this.onerror=function(){}),Array.isArray(this.src)){for(a=0;a<this.src.length;a+=1)if("string"!=typeof this.src[a])return b.error("AudioSampleLoader: src["+a+"] is not a string"),void this.onerror();for(this.response=new Array(this.src.length),a=0;a<this.src.length;a+=1)this.loadOneOfBuffers(this.src[a],a)}else{if("string"!=typeof this.src)return b.error("AudioSampleLoader: src not string or list of strings"),void this.onerror();this.loadOneBuffer(this.src)}},a.prototype.loadOneBuffer=function(a){"use strict";var b=window.console,c=this,d=new XMLHttpRequest;d.open("GET",a,!0),d.responseType="arraybuffer",d.onload=function(){c.ctx.decodeAudioData(d.response,function(a){c.response=a,c.onload()},function(){b.error("AudioSampleLoader: ctx.decodeAudioData() called onerror"),c.onerror()})},d.onerror=function(){b.error("AudioSampleLoader: XMLHttpRequest called onerror"),c.onerror()},d.send()},a.prototype.loadOneOfBuffers=function(a,b){"use strict";var c=window.console,d=this,e=new XMLHttpRequest;e.open("GET",a,!0),e.responseType="arraybuffer",e.onload=function(){d.ctx.decodeAudioData(e.response,function(a){d.response[b]=a,d.loaded+=1,d.loaded===d.src.length&&(d.loaded=0,d.onload())},function(){c.error("AudioSampleLoader: ctx.decodeAudioData() called onerror"),d.onerror()})},e.onerror=function(){c.error("AudioSampleLoader: XMLHttpRequest called onerror"),d.onerror()},e.send()},a}),app.factory("instruments",function(){return{Organ:[0,-0,-.042008,.010474,-.138038,.002641,-.001673,.001039,-.021054,651e-6,-422e-6,334e-6,-236e-6,191e-6,-161e-6,145e-6,-.018478,71e-6,-66e-6,47e-6,-44e-6,41e-6,-34e-6,31e-6,-3e-5,28e-6,-25e-6,24e-6,-22e-6,2e-5,-15e-6,13e-6,-.01157,4e-6,-3e-6,3e-6,-3e-6,3e-6,-3e-6,2e-6,-2e-6,2e-6,-2e-6,2e-6,-2e-6,2e-6,-2e-6,2e-6,-1e-6,1e-6,-1e-6,1e-6,-0,0,-0,0,-0,0,-0,0,-0,0,-0,0,-898e-6,1e-6,-1e-6,1e-6,-1e-6,1e-6,-1e-6,1e-6,-1e-6,1e-6,-1e-6,1e-6,-1e-6,1e-6,-1e-6,0,-0,0,-0,0,-0,0,-0,0,-0,0,-0,0,-0,0,-0,0,-0,0,-0,0,-0,0,-0,0,-0,0,-0],Horn:[0,.4,.4,1,1,1,.3,.7,.6,.5,.9,.8],instrumentNames:["Organ","Horn"]}}),app.factory("recordingFactory",function(){return function(){}}),app.factory("WaterModel",function(){return WaterCanvas=function(a,b,c,d,e){if(e=e||{},this.backgroundImageUrl=e.backgroundImageUrl||null,this.lightRefraction=e.lightRefraction||9,this.lightReflection=e.lightReflection||.1,this.showStats=e.showStats||!1,this.width=a,this.height=b,this.documentElement=document.getElementById(c),this.waterModel=d,this.canvas=document.createElement("canvas"),this.canvasHelp=document.createElement("canvas"),!this.canvas.getContext||!this.canvasHelp.getContext)return void alert("You need a browser that supports the HTML5 canvas tag.");if(this.ctx=this.canvas.getContext("2d"),this.ctxHelp=this.canvasHelp.getContext("2d"),this.setSize(a,b),this.documentElement.appendChild(this.canvas),this.fps=-1,this.showStats){this.fpsCounter=0,this.prevMs=0;var f=this;setInterval(function(){f.findFps()},1e3)}this.drawNextFrame()},WaterCanvas.prototype.setSize=function(a,b){this.width=a,this.height=b,this.canvas.setAttribute("width",this.width),this.canvas.setAttribute("height",this.height),this.canvasHelp.setAttribute("width",this.width),this.canvasHelp.setAttribute("height",this.height),this.setBackground(this.backgroundImageUrl)},WaterCanvas.prototype.setBackground=function(a){if(this.backgroundImageUrl=""==a?null:a,this.pixelsIn=null,null!=this.backgroundImageUrl){this.backgroundImg=new Image;var b=this;this.backgroundImg.onload=function(){b.ctxHelp.drawImage(b.backgroundImg,0,0,b.width,b.height);var a=b.ctxHelp.getImageData(0,0,b.width,b.height);b.pixelsIn=a.data,b.ctx.putImageData(a,0,0)},this.backgroundImg.src=this.backgroundImageUrl}else{var c=pointerCtx.createRadialGradient(this.width/2,this.height/2,0,this.width/2,this.height/2,this.height/2);c.addColorStop(0,"#4af"),c.addColorStop(1,"#000"),this.ctxHelp.fillStyle=c,this.ctxHelp.fillRect(0,0,this.width,this.height),this.ctxHelp.shadowColor="white",this.ctxHelp.shadowOffsetX=0,this.ctxHelp.shadowOffsetY=0,this.ctxHelp.shadowBlur=10,this.ctxHelp.textBaseline="top",this.ctxHelp.font="normal 200 45px verdana",this.ctxHelp.fillStyle="white",this.ctxHelp.fillText("Water Canvas",10,this.height/2-40),this.ctxHelp.font="normal 200 12px verdana",this.ctxHelp.fillText("Move your mouse over this canvas to move the water.",10,this.height/2+10),this.ctxHelp.fillText("By Almeros 2010, See http://code.almeros.com",10,this.height/2+30);var d=this.ctxHelp.getImageData(0,0,this.width,this.height);this.pixelsIn=d.data,this.ctx.putImageData(d,0,0)}},WaterCanvas.prototype.drawNextFrame=function(){if(null==this.pixelsIn||!this.waterModel.isEvolving()){var a=this;return void setTimeout(function(){a.drawNextFrame()},50)}for(var b=this.ctx.getImageData(0,0,this.width,this.height),c=b.data,d=0;n=c.length,d<n;d+=4){var e=d/4,f=e%this.width,g=(e-f)/this.width,h=this.waterModel.getWater(f,g),i=Math.round(h*this.lightRefraction),j=f+i,k=g+i;0>j&&(j=0),0>k&&(k=0),j>this.width-1&&(j=this.width-1),k>this.height-1&&(k=this.height-1);var l=4*(k*this.width+j),m=this.pixelsIn[l],o=this.pixelsIn[l+1],p=this.pixelsIn[l+2];h*=this.lightReflection,h+=1,c[d]=m*=h,c[d+1]=o*=h,c[d+2]=p*=h,c[d+3]=255}this.ctx.putImageData(b,0,0),this.showStats&&(this.fpsCounter++,this.ctx.textBaseline="top",this.ctx.font="normal 200 10px arial",this.ctx.fillStyle="white",this.ctx.shadowColor="black",this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.shadowBlur=2);var a=this;requestAnimFrame(function(){a.drawNextFrame()},this.canvas)},WaterCanvas.prototype.findFps=function(){if(this.showStats){var a=(new Date).getTime(),b=a-this.prevMs;this.fps=Math.round(1e3*this.fpsCounter/b*10)/10,this.prevMs=a,this.fpsCounter=0}},WaterCanvas.prototype.getFps=function(){return this.fps},WaterCanvas.prototype.setLightRefraction=function(a){this.lightRefraction=a},WaterCanvas.prototype.setLightReflection=function(a){this.lightReflection=a},WaterModel=function(a,b,c){if(c=c||{},this.resolution=c.resolution||2,this.interpolate=c.interpolate||!1,this.damping=c.damping||.985,this.clipping=c.clipping||5,this.maxFps=c.maxFps||30,this.showStats=c.showStats||!1,this.evolveThreshold=c.evolveThreshold||.05,this.width=Math.ceil(a/this.resolution),this.height=Math.ceil(b/this.resolution),this.resetSizeAndResolution(a,b,this.resolution),this.swapMap,this.setMaxFps(this.maxFps),this.evolving=!1,this.fps=-1,this.showStats){this.fpsCounter=0,this.prevMs=0;var d=this;setInterval(function(){d.findFps()},1e3)}},WaterModel.prototype.getWater=function(a,b){if(xTrans=a/this.resolution,yTrans=b/this.resolution,!this.interpolate||1==this.resolution)return xF=Math.floor(xTrans),yF=Math.floor(yTrans),xF>this.width-1||yF>this.height-1?0:this.depthMap1[xF][yF];if(xF=Math.floor(xTrans),yF=Math.floor(yTrans),xC=Math.ceil(xTrans),yC=Math.ceil(yTrans),xC>this.width-1||yC>this.height-1)return 0;var c=this.depthMap1[xF][yF],d=this.depthMap1[xC][yF],e=this.depthMap1[xF][yC],f=this.depthMap1[xC][yC],g=xC-xTrans,h=yC-yTrans,i=f*(1-g)*(1-h)+e*g*(1-h)+d*h*(1-g)+c*g*h;return i},WaterModel.prototype.setInterpolation=function(a){this.interpolate=a},WaterModel.prototype.touchWater=function(a,b,c,d){this.evolving=!0,a=Math.floor(a/this.resolution),b=Math.floor(b/this.resolution),(d.length>4||d[0].length>4)&&(a-=d.length/2,b-=d[0].length/2),0>a&&(a=0),0>b&&(b=0),a>this.width&&(a=this.width),b>this.height&&(b=this.height);for(var e=0;e<d.length;e++)for(var f=0;f<d[0].length;f++)a+e>=0&&b+f>=0&&a+e<=this.width-1&&b+f<=this.height-1&&(this.depthMap1[a+e][b+f]-=d[e][f]*c)},WaterModel.prototype.renderNextFrame=function(){if(this.evolving){this.evolving=!1;for(var a=0;a<this.width;a++)for(var b=0;b<this.height;b++){var c=(0==a?0:this.depthMap1[a-1][b])+(a==this.width-1?0:this.depthMap1[a+1][b])+(0==b?0:this.depthMap1[a][b-1])+(b==this.height-1?0:this.depthMap1[a][b+1]);c=(c/2-this.depthMap2[a][b])*this.damping,c>this.clipping&&(c=this.clipping),c<-this.clipping&&(c=-this.clipping),Math.abs(c)>this.evolveThreshold&&(this.evolving=!0),this.depthMap2[a][b]=c}this.swapMap=this.depthMap1,this.depthMap1=this.depthMap2,this.depthMap2=this.swapMap,this.fpsCounter++}},WaterModel.prototype.isEvolving=function(){return this.evolving},WaterModel.prototype.findFps=function(){if(this.showStats){var a=(new Date).getTime(),b=a-this.prevMs;this.fps=Math.round(1e3*this.fpsCounter/b*10)/10,this.prevMs=a,this.fpsCounter=0}},WaterModel.prototype.getFps=function(){return this.fps},WaterModel.prototype.setMaxFps=function(a){this.maxFps=a,clearInterval(this.maxFpsInterval);var b=this;this.maxFps>0&&(this.maxFpsInterval=setInterval(function(){b.renderNextFrame()},1e3/this.maxFps))},WaterModel.prototype.setDamping=function(a){this.damping=a},WaterModel.prototype.resetSizeAndResolution=function(a,b,c){this.width=Math.ceil(a/c),this.height=Math.ceil(b/c),this.resolution=c,this.depthMap1=new Array(this.width),this.depthMap2=new Array(this.width);for(var d=0;d<this.width;d++){this.depthMap1[d]=new Array(this.height),this.depthMap2[d]=new Array(this.height);for(var e=0;e<this.height;e++)this.depthMap1[d][e]=0,this.depthMap2[d][e]=0}},RainMaker=function(a,b,c,d){this.width=a,this.height=b,this.waterModel=c,this.raindrop2dArray=d,this.rainMinPressure=1,this.rainMaxPressure=3},RainMaker.prototype.raindrop=function(){var a=Math.floor(Math.random()*this.width),b=Math.floor(Math.random()*this.height);this.waterModel.touchWater(a,b,this.rainMinPressure+Math.random()*this.rainMaxPressure,this.raindrop2dArray)},RainMaker.prototype.setRaindropsPerSecond=function(a){if(this.rps=a,clearInterval(this.rainInterval),this.rps>0){var b=this;this.rainInterval=setInterval(function(){b.raindrop()},1e3/this.rps)}},RainMaker.prototype.setRainMinPressure=function(a){this.rainMinPressure=a},RainMaker.prototype.setRainMaxPressure=function(a){this.rainMaxPressure=a},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}(),WaterModel});